This is a simplified fintech application. It aims to simulate transactions between clients and shop wallets.

The registration methods exist only for data population purposes, and certain wallet and transfer GET methods are provided solely for demonstration. This is why these endpoints are not authenticated and do not include security layers.

The main endpoint of this application is POST /api/transfer. It handles transfers between users (common to common or common to shop) while ensuring atomicity by locking the user's wallet in the database and sending notifications via background jobs.

Transfers use external authorization and notification services. These were originally designed to use https://util.devi.tools/api/v2/authorize and https://util.devi.tools/api/v1/notify. However, as these services are currently unstable, mocks were implemented to simulate network delays and failures.


## Transfer Flow

The following diagram describes the business logic orchestrated by the `HandleTransferAction`:

```mermaid
sequenceDiagram
    participant U as User (Payer)
    participant API as API (TransferStoreController)
    participant DB as Database (Transaction)
    participant EXT as External Authorizer
    participant JOB as Notification Job

    U->>API: POST /api/transfer (payer, payee, value)
    
    API->>DB: Start Transaction
    
    alt Is Shop
        API-->>U: 403 Forbidden (Merchants cannot send money)
    else Is Common User
        Note over API,DB: First Balance Check
        alt Insufficient Balance
            API-->>U: 422 Unprocessable Entity
        else Sufficient Balance
            API->>EXT: Request Authorization
            
            alt Unauthorized
                EXT-->>API: Denied
                API->>DB: Rollback Transaction
                API-->>U: 401 Unauthorized
            else Authorized
                EXT-->>API: Approved
                
                Note over API,DB: Second Balance Check (Locking Row)
                API->>DB: SELECT FOR UPDATE
                
                alt Insufficient Balance (after lock)
                    API-->>U: 422 Unprocessable Entity
                else Sufficient Balance
                    API->>DB: Decrement Payer Balance
                    API->>DB: Increment Payee Balance
                    API->>DB: Create Transfer Record
                    API->>DB: Commit Transaction
                    
                    API->>JOB: Dispatch Notifications (Payer & Payee)
                    API-->>U: 201 Created (Success)
                end
            end
        end
    end
```

the documentation generated by scribe can be seen on /docs
